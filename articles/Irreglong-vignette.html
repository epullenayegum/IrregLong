<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="IrregLong">
<title>Analysis of longitudinal data with irregular observation times • IrregLong</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Analysis of longitudinal data with irregular observation times">
<meta property="og:description" content="IrregLong">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-inverse navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">IrregLong</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Irreglong-vignette.html">Analysis of longitudinal data with irregular observation times</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="Irreglong-vignette_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Analysis of longitudinal data with irregular observation times</h1>
                        <h4 data-toc-skip class="author">Eleanor M. Pullenayegum</h4>
            
            <h4 data-toc-skip class="date">2022-02-18</h4>
      
      
      <div class="d-none name"><code>Irreglong-vignette.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>Longitudinal data often has follow-up times that are irregular and potentially related to outcomes. For example, in a clinic-based cohort study where all follow-up is part of usual care, patients may visit more often when unwell. This risks over-estimating the burden of disease unless data are analysed appropriately. For example, in a study of HIV positive mothers, Buzkova et al <span class="citation">Buzkova, Brown, and John-Stewart (2010)</span> found a two-fold over-estimation of the estimated prevalence of pneumonia when analysis ignored the fact that women were more likely to visit between scheduled visits when they were unwell.</p>
<p>There are two categories of methods available for analysing this type of data: methods based on inverse-intensity weighting, and methods based on semi-parametric joint models (see <span class="citation">Pullenayegum and Lim (2016)</span> for an overview). This package provides methods for inverse-intensity weighting.</p>
<p>Inverse-intensity weighting weights data by the reciprocal of the intensity (or, equivalently, the hazard) of the visit process. Inverse-intensity weighting works in a similar way to survey weighting: observations with a higher intensity are over-represented in the data, and hence should receive less weight. Conversely, observations with lower intensity are under-represented in the data, and hence receive more weight. <span class="citation">Lin, Scharfstein, and Rosenheck (2004)</span> show that inverse-intensity weighting followed by a marginal analysis with a generalized estimating equation (GEE) results in unbiased estimation, subject to the assumptions set out below. This package contains functions to compute inverse-intensity weights, and also to fit inverse-intensity weighted GEEs.</p>
<p>Sometimes inference may be desired for a model for which weighting is not straightforward, for example a generalized linear mixed model or a latent class mixed model. In these cases, multiple outputation is a useful alternative to inverse-intensity weighting.</p>
<p>Multiple outputation works by discarding (outputting) excess data <span class="citation">(Hoffman, Sen, and Weinberg 2001; Follmann, Proschan, and Leifer 2003)</span>. Visits are randomly deleted from the dataset with probability inversely proportional to the visit intensity <span class="citation">(Pullenayegum 2016)</span>. The resulting thinned visit process is independent of the outcome process (subject to the assumptions below), and can hence be analysed using standard methods. To avoid wasting data, the random deletion is repeated multiple times and the results from each analysis combined. Conceptually, multiple outputation is the opposite of multiple imputation: where multiple imputation imputes missing observations multiple times, multiple outputation discards excess observations multiple times. This package contains functions to create outputted datasets, as well as to combine results across multiple outputations.</p>
</div>
<div class="section level3">
<h3 id="review-of-inverse-intensity-weighted-gees">Review of Inverse-intensity weighted GEEs<a class="anchor" aria-label="anchor" href="#review-of-inverse-intensity-weighted-gees"></a>
</h3>
<p>Suppose <span class="math inline">\(Y_i(t)\)</span> is the outcome of interest for subject <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>, let <span class="math inline">\(X_i(t)\)</span> be a possibly time-dependent covariate, and suppose interest is in the marginal model <span class="math display">\[E(Y_i(t)|X_i(t))=X_i(t)\beta.\]</span> Moreover, suppose that we observe <span class="math inline">\(Y_i\)</span> only at times <span class="math inline">\(T_{i1},T_{i2},\ldots, T_{in_i}\)</span>. Let <span class="math inline">\(N_i(t)\)</span> be the counting process for the visit times, that is <span class="math inline">\(N_i(t)=\sum_{j}I(T_{ij}\leq t)\)</span>, where <span class="math inline">\(I()\)</span> is an indicator function. Suppose moreover that there is a vector of observed covariates <span class="math inline">\(Z_i(t)\)</span> such that <span class="math display">\[\lim_{\delta \downarrow 0} \frac{E(N(t)-N(t-\delta))|Y_i(t),Z_i(t))}{\delta}=\frac{E(N(t)-N(t-\delta))|Z_i(t))}{\delta}=\lambda(t;Z_i(t))\]</span> for some hazard function <span class="math inline">\(\lambda\)</span>. If this assumption is not met, alternative methods of analysis should be considered (e.g. semi-parametric joint models).</p>
<p>The usual GEE equations will result in biased estimates of <span class="math inline">\(\beta\)</span> since <span class="math display">\[E(\sum_i\int_0^\tau X_i^\prime (Y_i(t) - X_i(t)\beta)dN_i(t)) =E(\sum_i\int_0^\tau X_i^\prime E((Y_i(t) - X_i(t)\beta)dN_i(t)\mid X_i(t)) \neq 0  \]</span> Provided that the conditional independence assumption holds, consistent estimates of <span class="math inline">\(\beta\)</span> may be obtained by weighting the GEE equations by <span class="math inline">\(sw_i(t)=s_0(t)/\lambda_i(t)\)</span> <span class="math display">\[E(\sum_i\int_0^\tau X_i^\prime sw_i(t)(Y_i(t) - X_i(t)\beta)dN_i(t)) =E(\sum_i\int_0^\tau X_i^\prime E(sw_i(t)(Y_i(t) - X_i(t)\beta)dN_i(t)\mid X_i(t),Y_i(t)) \\
= E(\sum_i\int_0^\tau X_i^\prime sw_i(t)(Y_i(t) - X_i(t)\beta)\lambda_i(t)dt=0.  \]</span></p>
</div>
<div class="section level3">
<h3 id="implementing-inverse-intensity-weighting">Implementing Inverse-Intensity weighting<a class="anchor" aria-label="anchor" href="#implementing-inverse-intensity-weighting"></a>
</h3>
<p>The first step in inverse-intensity weighting is to calculate the weights, usually by fitting a proportional hazards model to the recurrent event process formed by the visit times. That is, one fits the model <span class="math display">\[\lambda(t;Z_i(t))=\lambda_0(t)\exp(Z_i(t)\gamma).\]</span> This can be done using the coxph function, however the data usually requires some pre-processing. Firstly, the counting process formulation takes the form Surv(start.time,stop.time,event) and so typically requires the time variable to be lagged. Time-varying covariates will often need to be lagged as well. Secondly, if follow-up was stopped at a time later than the last visit, then additional rows capturing the censoring time must be added to the dataset. For example, if follow-up is stopped after two years, and an individual’s last visit is at 1.5 years, then we must include the information that there was no visit between 1.5 years and two years when estimating the visit intensity model. Using the data on just the observed visits ignores this.</p>
<p>The IrregLong package simplifies modelling of the visit process by creating a dataset with lagged variables (specified using lagvars=) and time intervals corresponding to censoring times (specified using maxfu=).</p>
<p>The inverse-intensity weight is <span class="math inline">\(w_i(t) = \frac{\exp(-Z_i(t)\gamma)}{\lambda_0(t)}\)</span>. Following <span class="citation">Buzkova and Lumley (2007)</span>, all inverse-intensity weights in this package are stabilized by the baseline hazard <span class="math inline">\(\lambda_0(t)\)</span>, so that the stabilized weight is <span class="math inline">\(sw_i(t)=\exp(-Z_i(t)\gamma)\)</span>. In some settings one may additionally wish to stabilize by a function of the time-invariant covariates in <span class="math inline">\(X_i(t)\)</span>, and an option to do so is included in the functions. One can then fit a GEE to obtain the regression coefficients <span class="math inline">\(\beta\)</span> corresponding to regressing <span class="math inline">\(Y_i(t)\)</span> on <span class="math inline">\(X_i(t)\)</span>, weighting by <span class="math inline">\(sw_i(t)\)</span>.</p>
<p>An important practical point is that when using inverse-intensity weighting the working variance for the GEE must be set to the identity. This is because functions for fitting GEEs interpret the weights as indicating heteroscedasticity. Thus if <span class="math inline">\(Y_i\)</span> is the vector of observations for subject <span class="math inline">\(i\)</span>, <span class="math inline">\(X_i\)</span> is the matrix of corresponding covariates, <span class="math inline">\(R_i\)</span> is the working variance matrix and <span class="math inline">\(D_i\)</span> is a diagonal matrix whose <span class="math inline">\(jj\)</span> entry of the weight for the <span class="math inline">\(j^{th}\)</span> observation for subject <span class="math inline">\(i\)</span>, then standard GEE software solves <span class="math display">\[\sum_iX_i^\prime D_i^{1/2}R_i^{-1}D_i^{1/2}(Y_i-X_i\beta)=0,\]</span> whereas we wish to solve <span class="math display">\[\sum_iX_i^\prime R_i^{-1}D_i(Y_i-X_i\beta)=0.\]</span> The two are, however, identical if <span class="math inline">\(R_i\)</span> is the identity matrix. While at first glance it may seem appealing to create a GEE estimation function that implements the weights as desired so as to allow for non-diagonal working variance matrices, note that the working variance should then be the variance of <span class="math inline">\(D_i(Y_i-X_i\beta)\)</span> rather than <span class="math inline">\((Y_i-X_i\beta)\)</span>. Since the weights usually involve time-dependent covariates that are often internal, the standard correlation structures (exchangeable, autoregressive) become less plausible.</p>
<div class="section level4">
<h4 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h4>
<p>These methods are illustrated using the Phenobarb dataset from the MEMSS package. Routine clinical pharmacokinetic data were collected from 59 preterm infants who received phenobarbital in order to prevent seizures. Blood draws were taken to determine serum concentration of phenobarbital, with the timing and number of draws varying among infants. For the purposes of illustration this analysis focuses not on pharmacokinetics but on the mean serum concentration of phenobarbital over time.</p>
<p>This dataset contains some rows corresponding to times at which phenobarbital given and others at which a blood draw was taken to determine serum phenobarbital concentration. For the visit intensity model, the event of interest is having a concentration measured, so we set the variable event=1 if concentration was measured and zero otherwise. The data is then restricted to those time points when a concentration measurement was taken. The original pharmacokinetic analysis restricts attention to the first 16 days of life, which we also do here.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://epullenayegum.github.io/IrregLong/">IrregLong</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">MEMSS</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">geepack</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Phenobarb</span><span class="op">)</span>
<span class="va">Phenobarb</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Phenobarb</span><span class="op">$</span><span class="va">conc</span><span class="op">)</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">Phenobarb</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">event</span><span class="op">==</span><span class="fl">1</span>,<span class="op">]</span>
<span class="va">data</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Subject</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">time</span><span class="op">&lt;</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span>,<span class="op">]</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">order</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">id</span>,<span class="va">data</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>,<span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##     Subject  Wt Apgar ApgarInd  time dose conc event id</span>
<span class="co">## 2         1 1.4     7     &gt;= 5   2.0   NA 17.3     1  1</span>
<span class="co">## 12        1 1.4     7     &gt;= 5 112.5   NA 31.0     1  1</span>
<span class="co">## 136      10 1.4     7     &gt;= 5   1.2   NA 19.9     1  2</span>
<span class="co">## 142      10 1.4     7     &gt;= 5  70.7   NA 23.4     1  2</span>
<span class="co">## 149      10 1.4     7     &gt;= 5 142.2   NA 30.9     1  2</span>
<span class="co">## 155      11 1.2     7     &gt;= 5  57.5   NA 24.3     1  3</span></code></pre>
<p>It can be helpful to begin by exploring the extent of visit irregularity. We begin with some simple summary statistics of the number of events per Subject, then plot times of measurement for each subjects.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">event</span>,<span class="va">data</span><span class="op">$</span><span class="va">Subject</span>,<span class="va">sum</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="co">##    1.00    2.00    3.00    2.61    3.00    6.00</span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/abacus.plot.html">abacus.plot</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">59</span>,time<span class="op">=</span><span class="st">"time"</span>,id<span class="op">=</span><span class="st">"Subject"</span>,data<span class="op">=</span><span class="va">data</span>,tmin<span class="op">=</span><span class="fl">0</span>,tmax<span class="op">=</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span>,
 xlab.abacus<span class="op">=</span><span class="st">"Time in hours"</span>,pch<span class="op">=</span><span class="fl">16</span>,col.abacus<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html" class="external-link">gray</a></span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Irreglong-vignette_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>This shows an median of 3 visits per subject with a range of 1 to 6. The plot shows that after an initial measurement shortly after birth, observations times vary among subjects.</p>
<p>The extent of irregularity can be further explored through a visit frequency plot. This plot is derived by dividing the time interval of interest into sets of bins with bin widths becoming increasingly wider across sets. For each set of bins, the mean proportion of individuals with 0, 1 or &gt;1 visit per bin is calculated. This is then plotted against either the number of bins or some other measure of bin width. When the study protocol does not specify recommended visit times, sets of bins can be defined either as intervals of equal widths (with different numbers of bins in each set), or as intervals for which the expected number of visits per bin is constant across bins (again, with varying numbers of bins in each set). The expected number of visits in a bin is simply the area under the cumulative hazard for that bin. The visit frequency plot shows that the mean proportion of individuals with 1 visit per bin is highest at 0.5 with 3 bins, and is clearly not consistent with repeated measures. Finally, the area under the curve (AUC) when the proportion of subjects with <span class="math inline">\(&gt;1\)</span> visits per bin is plotted against the proportion of subjects with <span class="math inline">\(0\)</span> visits per bin can be used as a numeric summary of the extent of irregularity. For perfect repeated measures, the AUC is 0; for a Poisson process, the AUC is 0.25. A log transformed version of the AUC is also available; for this version perfect repeated measures has a value of zero while a Poisson process has an AUC of 100. The AUC in this example is 0.18, with a transformed value of 64, demonstrating a high degree of irregularity.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"> <span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extent.of.irregularity.html">extent.of.irregularity</a></span><span class="op">(</span><span class="va">data</span>,time<span class="op">=</span><span class="st">"time"</span>,id<span class="op">=</span><span class="st">"id"</span>,
   scheduledtimes<span class="op">=</span><span class="cn">NULL</span>, cutpoints<span class="op">=</span><span class="cn">NULL</span>,ncutpts<span class="op">=</span><span class="fl">50</span>, 
   maxfu<span class="op">=</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span>, plot<span class="op">=</span><span class="cn">TRUE</span>,legendx<span class="op">=</span><span class="fl">30</span>,legendy<span class="op">=</span><span class="fl">0.8</span>,
  formula<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time.lag</span>,<span class="va">time</span>,<span class="va">event</span><span class="op">)</span><span class="op">~</span><span class="fl">1</span>,tau<span class="op">=</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span><span class="op">)</span></code></pre></div>
<p><img src="Irreglong-vignette_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">counts</span><span class="op">$</span><span class="va">auc</span></code></pre></div>
<pre><code><span class="co">## [1] 0.1814126</span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">counts</span><span class="op">$</span><span class="va">transformed.auc</span></code></pre></div>
<pre><code><span class="co">## [1] 65.02388</span></code></pre>
<p>To fit an inverse intensity weighted GEE, one begins by modelling the visit intensity. Although the IrregLong package includes a function that calculates both the inverse-intensity weights and the weighted GEE in a single command, it can be helpful to start by focussing on the visit intensity model. Modelling is usually done through a Cox proportional hazards model on the recurrent visit process. To do this, we need to specify time periods at risk, and so need to lag the time variable. If there are time-dependent covariates and we suspect that the value at the last measurement is predictive of when the next measurement will be taken, these time-dependent covariates must also be lagged. The IrregLong package simplifies this process by allowing the user to specify which covariates should be lagged (lagvars=c(“time”,“conc”)) and creating these lagged covariates internally (time.lag,conc.lag). The value of the lagged variables will by default be missing for the first observation in each subject, but this can be changed through the lagfirst argument. We set the lagged value of time at the first observed blood draw to be zero (lagfirst=0) since observation started at birth for all infants. Similarly, we set the lagged value of serum phenobarbital concentration to be zero at the first draw, since the last known value of serum concentration was at birth, prior to administration of phenobarbital, and allow for a non-linear relationship between concentration and log visit intensity.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span><span class="op">$</span><span class="va">Apgar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Apgar</span><span class="op">)</span>
<span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/iiw.weights.html">iiw.weights</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time.lag</span>,<span class="va">time</span>,<span class="va">event</span><span class="op">)</span><span class="op">~</span><span class="va">Wt</span> <span class="op">+</span> <span class="va">Apgar</span> <span class="op">+</span> 
                   <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> 
                <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">20</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">30</span><span class="op">)</span><span class="op">+</span>
      <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">Subject</span><span class="op">)</span>,id<span class="op">=</span><span class="st">"Subject"</span>,time<span class="op">=</span><span class="st">"time"</span>,event<span class="op">=</span><span class="st">"event"</span>,data<span class="op">=</span><span class="va">data</span>,
      invariant<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Subject"</span>,<span class="st">"Wt"</span>,<span class="st">"Apgar"</span><span class="op">)</span>,lagvars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>,<span class="st">"conc"</span><span class="op">)</span>,maxfu<span class="op">=</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span>,
      lagfirst<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,first<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="va">i</span><span class="op">$</span><span class="va">m</span></code></pre></div>
<pre><code><span class="co">## Call:</span>
<span class="co">## coxph(formula = Surv(time.lag, time, event) ~ Wt + Apgar + I(conc.lag &gt; </span>
<span class="co">##     0 &amp; conc.lag &lt;= 20) + I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30) + </span>
<span class="co">##     I(conc.lag &gt; 30), data = datacox, cluster = Subject)</span>
<span class="co">## </span>
<span class="co">##                                           coef exp(coef) se(coef) robust se</span>
<span class="co">## Wt                                    -0.11227   0.89380  0.12403   0.11276</span>
<span class="co">## Apgar                                 -0.02280   0.97746  0.03541   0.03914</span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE  -2.24896   0.10551  0.32814   0.40854</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE -2.66469   0.06962  0.33306   0.38537</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                  -2.98770   0.05040  0.42573   0.47461</span>
<span class="co">##                                            z        p</span>
<span class="co">## Wt                                    -0.996    0.319</span>
<span class="co">## Apgar                                 -0.582    0.560</span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE  -5.505 3.69e-08</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE -6.915 4.69e-12</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                  -6.295 3.07e-10</span>
<span class="co">## </span>
<span class="co">## Likelihood ratio test=71.26  on 5 df, p=5.589e-14</span>
<span class="co">## n= 213, number of events= 154</span></code></pre>
<p>Since Apgar score and birthweight are not significant, we consider whether the model can be simplified - first by including Apgar score as an indicator (<span class="math inline">\(\geq 5\)</span> vs. <span class="math inline">\(&lt;5\)</span>), then by removing variables that are not significant.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/iiw.weights.html">iiw.weights</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time.lag</span>,<span class="va">time</span>,<span class="va">event</span><span class="op">)</span><span class="op">~</span><span class="va">Wt</span> <span class="op">+</span> <span class="va">ApgarInd</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> 
                <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">20</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">30</span><span class="op">)</span><span class="op">+</span> 
      <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">Subject</span><span class="op">)</span>,id<span class="op">=</span><span class="st">"Subject"</span>,time<span class="op">=</span><span class="st">"time"</span>,event<span class="op">=</span><span class="st">"event"</span>,data<span class="op">=</span><span class="va">data</span>,
      invariant<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Subject"</span>,<span class="st">"Wt"</span>,<span class="st">"ApgarInd"</span><span class="op">)</span>,lagvars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>,<span class="st">"conc"</span><span class="op">)</span>, maxfu<span class="op">=</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span>,lagfirst<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,first<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="va">i</span><span class="op">$</span><span class="va">m</span></code></pre></div>
<pre><code><span class="co">## Call:</span>
<span class="co">## coxph(formula = Surv(time.lag, time, event) ~ Wt + ApgarInd + </span>
<span class="co">##     I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20) + I(conc.lag &gt; 20 &amp; conc.lag &lt;= </span>
<span class="co">##     30) + I(conc.lag &gt; 30), data = datacox, cluster = Subject)</span>
<span class="co">## </span>
<span class="co">##                                           coef exp(coef) se(coef) robust se</span>
<span class="co">## Wt                                    -0.16625   0.84683  0.12404   0.12749</span>
<span class="co">## ApgarInd&gt;= 5                           0.29125   1.33810  0.22949   0.34827</span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE  -2.35868   0.09455  0.34240   0.37226</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE -2.75127   0.06385  0.34814   0.32775</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                  -3.11277   0.04448  0.44268   0.44155</span>
<span class="co">##                                            z        p</span>
<span class="co">## Wt                                    -1.304    0.192</span>
<span class="co">## ApgarInd&gt;= 5                           0.836    0.403</span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE  -6.336 2.36e-10</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE -8.395  &lt; 2e-16</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                  -7.050 1.79e-12</span>
<span class="co">## </span>
<span class="co">## Likelihood ratio test=72.57  on 5 df, p=2.994e-14</span>
<span class="co">## n= 213, number of events= 154</span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/iiw.weights.html">iiw.weights</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time.lag</span>,<span class="va">time</span>,<span class="va">event</span><span class="op">)</span><span class="op">~</span><span class="va">Wt</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> 
                <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">20</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">30</span><span class="op">)</span><span class="op">+</span> 
      <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">Subject</span><span class="op">)</span>,id<span class="op">=</span><span class="st">"Subject"</span>,time<span class="op">=</span><span class="st">"time"</span>,event<span class="op">=</span><span class="st">"event"</span>,data<span class="op">=</span><span class="va">data</span>,
      invariant<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Subject"</span>,<span class="st">"Wt"</span><span class="op">)</span>,lagvars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>,<span class="st">"conc"</span><span class="op">)</span>,maxfu<span class="op">=</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span>,lagfirst<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,first<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="va">i</span><span class="op">$</span><span class="va">m</span></code></pre></div>
<pre><code><span class="co">## Call:</span>
<span class="co">## coxph(formula = Surv(time.lag, time, event) ~ Wt + I(conc.lag &gt; </span>
<span class="co">##     0 &amp; conc.lag &lt;= 20) + I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30) + </span>
<span class="co">##     I(conc.lag &gt; 30), data = datacox, cluster = Subject)</span>
<span class="co">## </span>
<span class="co">##                                           coef exp(coef) se(coef) robust se</span>
<span class="co">## Wt                                    -0.13679   0.87215  0.11897   0.11778</span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE  -2.26719   0.10360  0.32831   0.40747</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE -2.66595   0.06953  0.33457   0.37910</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                  -2.99587   0.04999  0.42698   0.47295</span>
<span class="co">##                                            z        p</span>
<span class="co">## Wt                                    -1.161    0.245</span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE  -5.564 2.63e-08</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE -7.032 2.03e-12</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                  -6.334 2.38e-10</span>
<span class="co">## </span>
<span class="co">## Likelihood ratio test=70.86  on 4 df, p=1.496e-14</span>
<span class="co">## n= 213, number of events= 154</span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/iiw.weights.html">iiw.weights</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time.lag</span>,<span class="va">time</span>,<span class="va">event</span><span class="op">)</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> 
                <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">20</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span> 
      <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">Subject</span><span class="op">)</span>,id<span class="op">=</span><span class="st">"Subject"</span>,time<span class="op">=</span><span class="st">"time"</span>,event<span class="op">=</span><span class="st">"event"</span>,data<span class="op">=</span><span class="va">data</span>,
      invariant<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Subject"</span>,<span class="st">"Wt"</span><span class="op">)</span>,lagvars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>,<span class="st">"conc"</span><span class="op">)</span>,maxfu<span class="op">=</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span>,lagfirst<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,first<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="va">i</span><span class="op">$</span><span class="va">m</span></code></pre></div>
<pre><code><span class="co">## Call:</span>
<span class="co">## coxph(formula = Surv(time.lag, time, event) ~ I(conc.lag &gt; 0 &amp; </span>
<span class="co">##     conc.lag &lt;= 20) + I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30) + I(conc.lag &gt; </span>
<span class="co">##     30), data = datacox, cluster = Subject)</span>
<span class="co">## </span>
<span class="co">##                                           coef exp(coef) se(coef) robust se</span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE  -2.27453   0.10284  0.33148   0.40497</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE -2.67331   0.06902  0.33681   0.37398</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                  -2.99982   0.04980  0.42794   0.46762</span>
<span class="co">##                                            z        p</span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE  -5.617 1.95e-08</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE -7.148 8.79e-13</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                  -6.415 1.41e-10</span>
<span class="co">## </span>
<span class="co">## Likelihood ratio test=69.47  on 3 df, p=5.542e-15</span>
<span class="co">## n= 213, number of events= 154</span></code></pre>
<p>It thus appears that last concentration is predictive of the time to the next concentration measurement.</p>
<p>Having established a model for the visit intensity, we now turn to modelling the serum concentration as a function of time. A plot of concentration over time shows that the relationship is unlikely to be linear, even in the weighted data. We thus use fractional polynomials to model the shape of the association over time.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">time</span>,<span class="va">data</span><span class="op">$</span><span class="va">conc</span>,xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">200</span><span class="op">)</span>,pch<span class="op">=</span><span class="fl">16</span>, xlab<span class="op">=</span><span class="st">"Time in hours"</span>, ylab<span class="op">=</span><span class="st">"Concentration"</span><span class="op">)</span></code></pre></div>
<p><img src="Irreglong-vignette_files/figure-html/fig3-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Fractional polynomials consider powers of -2, -1, -0.5, 0.5, 1, 2, 3, and a log-transform, and use the best-fitting from among these. Since weighting tends not to lead to dramatic changes in the shape of the relationship between outcome and covariates, we use the unweighted data to choose the functional form of time, and use the adjusted R-squared as a measure of goodness of fit.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsq1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim<span class="op">=</span><span class="fl">8</span><span class="op">)</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="va">time</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">0.5</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">rsq1</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 5</span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsq1</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">rsq1</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code><span class="co">## [1] 0.1952896</span></code></pre>
<p>Based on this, we choose the log transform of time, and now-consider whether a second order fractional polynomial would improve the fit. This involves adding, in turn, each of the powers previously considered, as well as <span class="math inline">\(time\times\log(time)\)</span>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsq2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim<span class="op">=</span><span class="fl">8</span><span class="op">)</span>
<span class="va">rsq2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">+</span> <span class="va">time</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">0.5</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq2</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq2</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq2</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">+</span> <span class="va">time</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq2</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">time</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq2</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq2</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">rsq2</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 4</span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsq2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">rsq2</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code><span class="co">## [1] 0.3468345</span></code></pre>
<p>We thus use time^3 and log(time) to describe concentration over time. We also check for the best functional form in the weighted data:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsq1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim<span class="op">=</span><span class="fl">8</span><span class="op">)</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="va">time</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">0.5</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">rsq1</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 4</span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsq1</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">rsq1</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code><span class="co">## [1] 0.163227</span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsq1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span>dim<span class="op">=</span><span class="fl">8</span><span class="op">)</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span><span class="va">time</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">0.5</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">time</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="va">rsq1</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,data<span class="op">=</span><span class="va">data</span>,weight<span class="op">=</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">adj.r.squared</span>
<span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">rsq1</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 1</span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rsq1</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">rsq1</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code><span class="co">## [1] 0.3353907</span></code></pre>
<p>In all models, we thus use time, time^3, and log(time). The inverse-intensity-weighted GEE can be fitted using the function iiwgee. This function specifies first the formula for the GEE, then the formula for the inverse intensity weights.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iiwgee</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/iiwgee.html">iiwgee</a></span><span class="op">(</span><span class="va">conc</span> <span class="op">~</span> <span class="va">time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">time</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time.lag</span>,<span class="va">time</span>,<span class="va">event</span><span class="op">)</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> 
                <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">20</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/cluster.html" class="external-link">cluster</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,
        formulanull<span class="op">=</span><span class="cn">NULL</span>,id<span class="op">=</span><span class="st">"id"</span>,time<span class="op">=</span><span class="st">"time"</span>,event<span class="op">=</span><span class="st">"event"</span>,data<span class="op">=</span><span class="va">data</span>,
        invariant<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>,<span class="st">"Wt"</span><span class="op">)</span>,lagvars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>,<span class="st">"conc"</span><span class="op">)</span>,maxfu<span class="op">=</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span>,lagfirst<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,first<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Note that the iiwgee function does not include an option for the working variance. As discussed above, when working with inverse-intensity weights, the working variance should always be the identity. The iiwgee function returns the inverse-intensity weighted GEE fit:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">iiwgee</span><span class="op">$</span><span class="va">geefit</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## </span>
<span class="co">## Call:</span>
<span class="co">## geeglm(formula = formulagee, family = family, data = data, weights = useweight, </span>
<span class="co">##     id = iddup, corstr = "independence")</span>
<span class="co">## </span>
<span class="co">##  Coefficients:</span>
<span class="co">##               Estimate    Std.err    Wald Pr(&gt;|W|)    </span>
<span class="co">## (Intercept)  1.912e+01  1.268e+00 227.512  &lt; 2e-16 ***</span>
<span class="co">## time         1.060e-01  2.571e-02  16.988 3.76e-05 ***</span>
<span class="co">## I(time^3)   -1.469e-06  2.079e-07  49.917 1.60e-12 ***</span>
<span class="co">## log(time)    7.501e-01  7.583e-01   0.978    0.323    </span>
<span class="co">## ---</span>
<span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">## </span>
<span class="co">## Correlation structure = independence </span>
<span class="co">## Estimated Scale Parameters:</span>
<span class="co">## </span>
<span class="co">##             Estimate Std.err</span>
<span class="co">## (Intercept)    57.87   27.08</span>
<span class="co">## Number of clusters:   59  Maximum cluster size: 6</span></code></pre>
<p>For comparison, we also fit the unweighted GEE, and plot the two serum concentration trajectories</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/geepack/man/geeglm.html" class="external-link">geeglm</a></span><span class="op">(</span><span class="va">conc</span> <span class="op">~</span> <span class="va">time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">time</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> , id<span class="op">=</span><span class="va">Subject</span>, data<span class="op">=</span><span class="va">data</span><span class="op">)</span>
<span class="va">time</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">200</span><span class="op">)</span>
<span class="va">unweighted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">199</span><span class="op">)</span>,<span class="va">time</span>,<span class="va">time</span><span class="op">^</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">m</span><span class="op">$</span><span class="va">coefficients</span>
<span class="va">weighted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">199</span><span class="op">)</span>,<span class="va">time</span>,<span class="va">time</span><span class="op">^</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">iiwgee</span><span class="op">$</span><span class="va">geefit</span><span class="op">$</span><span class="va">coefficients</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">time</span>,<span class="va">data</span><span class="op">$</span><span class="va">conc</span>,xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">199</span><span class="op">)</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">unweighted</span>,<span class="va">weighted</span>,<span class="va">data</span><span class="op">$</span><span class="va">conc</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">unweighted</span>,<span class="va">weighted</span>,<span class="va">data</span><span class="op">$</span><span class="va">conc</span><span class="op">)</span><span class="op">)</span>,pch<span class="op">=</span><span class="fl">16</span>,xlab<span class="op">=</span><span class="st">"Time"</span>,ylab<span class="op">=</span><span class="st">"Serum phenobarbital concentration"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">unweighted</span>,type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">weighted</span>,col<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span> <span class="op">(</span><span class="fl">0</span>,<span class="fl">60</span>,legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Unweighted"</span>,<span class="st">"Inverse-intensity weighted"</span><span class="op">)</span>,col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,bty<span class="op">=</span><span class="st">"n"</span>,lty<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="Irreglong-vignette_files/figure-html/fig2-1.png" width="576" style="display: block; margin: auto;"></p>
<p>The iiwgee function also returns the fitted visit intensity model:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">iiwgee</span><span class="op">$</span><span class="va">phfit</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Call:</span>
<span class="co">## coxph(formula = Surv(time.lag, time, event) ~ I(conc.lag &gt; 0 &amp; </span>
<span class="co">##     conc.lag &lt;= 20) + I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30) + I(conc.lag &gt; </span>
<span class="co">##     30), data = datacox, cluster = id)</span>
<span class="co">## </span>
<span class="co">##   n= 213, number of events= 154 </span>
<span class="co">## </span>
<span class="co">##                                          coef exp(coef) se(coef) robust se</span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE  -2.2745    0.1028   0.3315    0.4050</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE -2.6733    0.0690   0.3368    0.3740</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                  -2.9998    0.0498   0.4279    0.4676</span>
<span class="co">##                                           z Pr(&gt;|z|)    </span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE  -5.62  1.9e-08 ***</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE -7.15  8.8e-13 ***</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                  -6.42  1.4e-10 ***</span>
<span class="co">## ---</span>
<span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">## </span>
<span class="co">##                                       exp(coef) exp(-coef) lower .95 upper .95</span>
<span class="co">## I(conc.lag &gt; 0 &amp; conc.lag &lt;= 20)TRUE     0.1028       9.72    0.0465     0.227</span>
<span class="co">## I(conc.lag &gt; 20 &amp; conc.lag &lt;= 30)TRUE    0.0690      14.49    0.0332     0.144</span>
<span class="co">## I(conc.lag &gt; 30)TRUE                     0.0498      20.08    0.0199     0.125</span>
<span class="co">## </span>
<span class="co">## Concordance= 0.624  (se = 0.014 )</span>
<span class="co">## Likelihood ratio test= 69.5  on 3 df,   p=6e-15</span>
<span class="co">## Wald test            = 54.4  on 3 df,   p=9e-12</span>
<span class="co">## Score (logrank) test = 69.1  on 3 df,   p=7e-15,   Robust = 56.1  p=4e-12</span>
<span class="co">## </span>
<span class="co">##   (Note: the likelihood ratio and score tests assume independence of</span>
<span class="co">##      observations within a cluster, the Wald and robust score tests do not).</span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="multiple-outputation">Multiple Outputation<a class="anchor" aria-label="anchor" href="#multiple-outputation"></a>
</h3>
<p>Once the inverse-intensity weights have been calculated, an alternative use for them is to perform multiple outputation. When some of the weights are very large, this can result in very small outputted datasets, and so it can be helpful to truncate the weights. Moreover, the smaller sample size of each outputted dataset results in collinearity on including all three functions of time, so for this analysis we use time and time^3 only, as these were the best fit in the weighted data. The code below computes 20 outputted datasets, analyses each using an unweighted GEE, then combines the results.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">geesmv</span><span class="op">)</span>


<span class="va">reg</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span>
  <span class="va">est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/geepack/man/geeglm.html" class="external-link">geeglm</a></span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="va">time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">time</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span>, id<span class="op">=</span><span class="va">id</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">1</span><span class="op">)</span> <span class="va">est</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">GEE.var.md</span><span class="op">(</span><span class="va">conc</span><span class="op">~</span><span class="va">time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">time</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> , id<span class="op">=</span><span class="va">id</span>,data<span class="op">=</span><span class="va">data</span><span class="op">)</span><span class="op">$</span><span class="va">cov.beta</span>
  <span class="va">est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.matrix.html" class="external-link">data.matrix</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">est</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">301031</span><span class="op">)</span>
<span class="va">wt</span> <span class="op">&lt;-</span> <span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span>
<span class="va">wt</span><span class="op">[</span><span class="va">wt</span><span class="op">&gt;</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span>,<span class="fl">0.95</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">i</span><span class="op">$</span><span class="va">iiw.weight</span>,<span class="fl">0.95</span><span class="op">)</span>
<span class="va">m.mogee</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mo.html">mo</a></span><span class="op">(</span><span class="fl">20</span>,<span class="va">reg</span>,<span class="va">data</span>,<span class="va">wt</span>, singleobs<span class="op">=</span><span class="cn">FALSE</span>,id<span class="op">=</span><span class="st">"id"</span>,time<span class="op">=</span><span class="st">"time"</span>,keep.first<span class="op">=</span><span class="cn">FALSE</span>,var<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">m.mogee</span></code></pre></div>
<p>The multiple outputation estimates of the regression coefficients (<code>$est</code>), and is the mean across outputations of the GEE estimates. The multiple outputation standard error (<code>$se</code>) is a function of both the within outputation standard errors and the between outputation variance. The relative efficiency of using 20 outputations in place of all possible outputations is given by <code>RE.MO</code>. In this example the number of observations per subject becomes small on outputation, resulting in the usual sandwich variance estimator for the GEE underestimating the standard error. For this reason, we use a small sample sandwich variance correction from the “geesmv” package. There are a number of options available, and in this example we have used the Mancl deRouen correction <span class="citation">(Mancl and DeRouen 2001)</span>. The multiple outputation estimates based on the above seed were 16.0 (SE 1.53), -7.72e-07 (SE 1.16e-07) and 3.42 (SE 5.52) for the intercept, <span class="math inline">\(time\)</span>, and <span class="math inline">\(time^3\)</span> respectively. The relative efficiencies were 1.01, 1.008, and 1.008, suggesting that there is little to be gained by running more outputations.</p>
<p>Multiple outputation is helpful for analyses where weighting is difficult to implement. One such example is a semi-parametric joint model. Semi-parametric joint models are useful when there are latent variables that influence both the outcome and visit processes. We consider the Liang <span class="citation">(Liang, Lu, and Ying 2009)</span> semi-parametric joint model: <span class="math display">\[Y_i(t)=\beta_0(t) + X_i(t)\beta + W_i(t)\nu_{i1} + \epsilon_i(t) \]</span> <span class="math display">\[\lambda_i(t)=\nu_{i2}\lambda_0(t)\exp(U_i\gamma) \]</span> where <span class="math inline">\(W_i(t)\)</span> is a subset of the covariates <span class="math inline">\(X_i(t)\)</span>, <span class="math inline">\(U_i\)</span> is a vector of baseline covariates, <span class="math inline">\(\epsilon_i(t)\)</span> is a mean-zero random error, and <span class="math inline">\(\nu_{i1}\)</span>, <span class="math inline">\(\nu_{i2}\)</span> are (potentially correlated) random effects.</p>
<p>The Liang model requires that the covariates in the model for the visits be time invariant. In practice, <span class="math display">\[\lambda_i(t)=\nu_{i2}\lambda_0(t)\exp(Z_i(t)\gamma), \]</span> for an observed vector of time-dependent auxiliary covariates <span class="math inline">\(Z_i(t)\)</span> may be more reasonable. Multiple outputation makes inference under this model possible by creating outputted datasets in which the visit process does not depend on the observed covariates <span class="math inline">\(Z_i(t)\)</span>. These datasets can be analysed using Liang’s method for the special case where there are no covariates in the visit process model.</p>
<div class="section level4">
<h4 id="example-1">Example<a class="anchor" aria-label="anchor" href="#example-1"></a>
</h4>
<p>We consider the same example as before, now examining whether the concentration differs between those with an Apgar score &lt;5 at birth and those with a score &gt;=5, and allowing a random intercept that is potentially correlated with a frailty variable in the visit process. That is, we take <span class="math display">\[conc_i(t)=\beta_0(t) + \beta_1I(Apgar_i&lt;5) + \beta_2I(Apgar\geq 5)t + \beta_3I(Apgar\geq 5)t^3 +  \nu_{i1} + \epsilon_i(t),\]</span> with visit process model given by <span class="math display">\[\lambda_i(t)=\nu_{i2}\lambda_0(t)\exp(I(0&lt;conc_i(T_{iN_i(t^-)})\leq 20)\gamma_1 + I(20&lt; conc_i(T_{iN_i(t^-)})\leq 30)\gamma_2 +\\
I(conc_i(T_{iN_i(t^-)})&gt; 30)\gamma_3, \]</span> where <span class="math inline">\(\nu_{i1}=(\nu_{i11},\nu_{i12})^\prime\)</span> and <span class="math inline">\(\nu_{i2}\)</span> are potentially correlated with <span class="math inline">\(E(\nu_{i1}\mid\nu_{i2})=\theta(\nu_{i2}-1)\)</span> for some <span class="math inline">\(\theta\)</span>. Note that when calculating the weights used for outputation, the <code>frailty=TRUE</code> option should be used in visit intensity calculation because the lagged concentration is an internal covariate that is potentially correlated with the frailty variable, and the Cox model is non-collapsible. For this analysis, time is transformed to days rather than hours to avoid computational problems with the Liang function.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Liangmo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>,<span class="va">Yname</span>,<span class="va">Xnames</span>,<span class="va">Wnames</span>,<span class="va">maxfu</span>,<span class="va">baseline</span><span class="op">)</span><span class="op">{</span>
 <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Liang.html">Liang</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">data</span>,Yname<span class="op">=</span><span class="va">Yname</span>,Xnames<span class="op">=</span><span class="va">Xnames</span>,Wnames<span class="op">=</span><span class="va">Wnames</span>,id<span class="op">=</span><span class="st">"id"</span>,time<span class="op">=</span><span class="st">"time"</span>,
            maxfu<span class="op">=</span><span class="va">maxfu</span>,baseline<span class="op">=</span><span class="va">baseline</span>,Xfn<span class="op">=</span><span class="va">Xfn</span>,Wfn<span class="op">=</span><span class="va">Wfn</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>; <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">Xfn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span>,<span class="va">time</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># Group is time invariant so just use the first value for each subject</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">ApgarInd</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">id</span><span class="op">==</span><span class="va">id</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">Wfn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span>,<span class="va">time</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">time</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">data</span><span class="op">$</span><span class="va">Intercept</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">data</span><span class="op">$</span><span class="va">time3</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span>
<span class="va">data</span><span class="op">$</span><span class="va">logtime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>
<span class="va">data</span><span class="op">$</span><span class="va">ApgarInd.time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">ApgarInd</span><span class="op">)</span><span class="op">*</span><span class="va">data</span><span class="op">$</span><span class="va">time</span><span class="op">/</span><span class="fl">24</span>
<span class="va">data</span><span class="op">$</span><span class="va">ApgarInd.time3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">ApgarInd</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">time</span><span class="op">/</span><span class="fl">24</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">301031</span><span class="op">)</span>
<span class="va">ifrailty</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/iiw.weights.html">iiw.weights</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time.lag</span>,<span class="va">time</span>,<span class="va">event</span><span class="op">)</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> 
                <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">20</span> <span class="op">&amp;</span> <span class="va">conc.lag</span><span class="op">&lt;=</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">conc.lag</span><span class="op">&gt;</span><span class="fl">30</span><span class="op">)</span>   
                      <span class="op">+</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/frailty.html" class="external-link">frailty</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,id<span class="op">=</span><span class="st">"id"</span>,time<span class="op">=</span><span class="st">"time"</span>,event<span class="op">=</span><span class="st">"event"</span>,data<span class="op">=</span><span class="va">data</span>,     
                      invariant<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">)</span>,lagvars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>,<span class="st">"conc"</span><span class="op">)</span>,maxfu<span class="op">=</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span>,
                      lagfirst<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, first<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>

<span class="va">wt</span> <span class="op">&lt;-</span> <span class="va">ifrailty</span><span class="op">$</span><span class="va">iiw.weight</span>

<span class="va">m.moLiang</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mo.html">mo</a></span><span class="op">(</span><span class="fl">20</span>,<span class="va">Liangmo</span>,<span class="va">data</span>,<span class="va">wt</span>, 
         singleobs<span class="op">=</span><span class="cn">FALSE</span>,id<span class="op">=</span><span class="st">"id"</span>,time<span class="op">=</span><span class="st">"time"</span>,keep.first<span class="op">=</span><span class="cn">FALSE</span>,var<span class="op">=</span><span class="cn">FALSE</span>,Yname<span class="op">=</span><span class="st">"conc"</span>,
         Xnames<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ApgarInd"</span>,<span class="st">"ApgarInd.time"</span>,<span class="st">"ApgarInd.time3"</span><span class="op">)</span>, 
         Wnames<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Intercept"</span><span class="op">)</span>,maxfu<span class="op">=</span><span class="fl">16</span><span class="op">*</span><span class="fl">24</span>,baseline<span class="op">=</span><span class="fl">0</span><span class="op">)</span>

<span class="va">m.moLiang</span><span class="op">$</span><span class="va">est</span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m.moLiang</span><span class="op">$</span><span class="va">est</span></code></pre></div>
<pre><code><span class="co">## [1] -20.15766   5.25885  -0.02689        NA   0.00000</span></code></pre>
<p>The first three coefficients represent for the Apgar score, its interaction with time, and its interaction with time^3 respectively, while the fourth coefficient is the estimated value of <span class="math inline">\(\theta\)</span> and the final entry is the estimated variance of the frailty variable in the visit process model. Since in this case the estimated frailty is zero, we can conclude that the Liang model is not needed.</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references">
<div id="ref-Buzkova2010">
<p>Buzkova, P., E. R. Brown, and G. C. John-Stewart. 2010. “Longitudinal Data Analysis for Generalized Linear Models Under Participant-Driven Informative Follow-up: An Application in Maternal Health Epidemiology.” <em>American Journal of Epidemiology</em> 171: 189–97.</p>
</div>
<div id="ref-BuzkovaCJS2007">
<p>Buzkova, P., and T. Lumley. 2007. “Longitudinal Data Analysis for Generalized Linear Models with Follow-up Dependent on Outcome-Related Variables.” <em>The Canadian Journal of Statistics</em> 35: 485–500.</p>
</div>
<div id="ref-Follmann2003">
<p>Follmann, D., M. Proschan, and E. Leifer. 2003. “Multiple Outputation: Inference for Complex Clustered Data by Averaging Analyses from Independent Data.” <em>Biometrics</em> 59: 420–29.</p>
</div>
<div id="ref-Hoffman2001">
<p>Hoffman, E. B., P. K. Sen, and C. Weinberg. 2001. “Within-Cluster Resampling.” <em>Biometrika</em> 88: 1121–34.</p>
</div>
<div id="ref-Liang2009">
<p>Liang, Y., W. Lu, and Z. Ying. 2009. “Joint Modeling and Analysis of Longitudinal Data with Informative Observation Times.” <em>Biometrics</em> 65: 377–84.</p>
</div>
<div id="ref-LSR">
<p>Lin, H., D. O. Scharfstein, and R. A. Rosenheck. 2004. “Analysis of Longitudinal Data with Irregular, Outcome-Dependent Follow-up.” <em>Journal of the Royal Statistical Society, Series B</em> 66: 791–813.</p>
</div>
<div id="ref-Mancl2001">
<p>Mancl, LA, and TA DeRouen. 2001. “A Covariance Estimator for Gee with Improved Small-Sample Properties.” Journal Article. <em>Biometrics</em> 57 (1): 126–34. <a href="https://doi.org/10.1111/j.0006-341X.2001.00126.x" class="external-link">https://doi.org/10.1111/j.0006-341X.2001.00126.x</a>.</p>
</div>
<div id="ref-Pullenayegum2016">
<p>Pullenayegum, E. M. 2016. “Multiple Outputation for the Analysis of Longitudinal Data Subject to Irregular Observation.” <em>Statistics in Medicine</em> 35: 1800–1818.</p>
</div>
<div id="ref-Pullenayegum2015">
<p>Pullenayegum, E. M., and L. S. H. Lim. 2016. “Longitudinal Data Subject to Irregular Observation: A Review of Methods with a Focus on Visit Processes, Assumptions, and Study Design.” <em>Statistical Methods in Medical Research</em> 25: 2992–3014.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://lab.research.sickkids.ca/pullenayegum/" class="external-link">Eleanor Pullenayegum</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
